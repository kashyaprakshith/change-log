name: Check Tags Workflow

on:
  push:
    branches:
      - main

jobs:
  check_tags:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest-tag
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0) 
          echo "LATEST_TAG=${LATEST_TAG}" >> "$GITHUB_ENV"
          
      - name: Get previous tag
        id: previous-tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $(git rev-list --tags --skip=1 -n 1)) 
          echo "PREVIOUS_TAG=$PREVIOUS_TAG" >> "$GITHUB_ENV"

      - name: Debug Tags
        run: | 
          echo "the latest tag is ${LATEST_TAG}"
          echo "the PREVIOUS tag is ${PREVIOUS_TAG}"

     # - name: get release notes 
     #   id: release-not
     #   run: |
     #     NOTES=$(git log 4.0.0..5.0.0 --pretty='%s' | grep -E '\[\b[A-Z][A-Z0-9_]+-[1-9][0-9]*\]\[(major|minor|patch)\]:\s\w+' | sed "s/\[.*\]\[.*\]: /- /g")
     #     echo "RELEASE_NOTES=$NOTES" >> "$GITHUB_ENV"

      - name: get release notes 
        id: release-not
        run: |
          NOTES=$(git log 4.0.0..5.0.0 --pretty='%s' | grep -E '\[\b[A-Z][A-Z0-9_]+-[1-9][0-9]*\]\[(major|minor|patch)\]:\s\w+' | sed "s/\[.*\]\[.*\]: /- /g")
          echo -e "RELEASE_NOTES=$NOTES <<EOF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

     
      - run: echo -e "${{ env.RELEASE_NOTES }}"
          
      - name: Update Changelog
        uses: stefanzweifel/changelog-updater-action@v1
        with:
          latest-version: ${{ env.LATEST_TAG }}
          release-notes: |
            ### Added
             - New Feature A
             - New Feature B

            ### Changed
             - Update Feature C

            ### Removes
             - Remove Feature D

      - name: Commit updated CHANGELOG
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: ${{ github.event.release.target_commitish }}
          commit_message: Update CHANGELOG
          file_pattern: CHANGELOG.md
